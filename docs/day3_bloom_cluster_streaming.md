# День 3: Anti-Fraud, Streaming Analytics и Кластер

## Часть 1: Anti-Fraud и Bloom Filter
В системах борьбы с мошенничеством (Fraud Detection) мы проверяем каждый звонок: "Есть ли этот номер в черном списке?".
Специфика:
- 99.9% номеров — честные (их **нет** в черном списке).
- Если просто искать в LSM (SSTable), то на каждый "честный" звонок мы будем зря перебирать файлы на диске, чтобы убедиться, что ключа там нет. Это **Read Amplification** на miss-запросах.

**Bloom Filter** — это битовая маска, которая живет в оперативной памяти.
- Если фильтр говорит "НЕТ" — ключа точно нет на диске. Экономим 100% I/O.
- Если фильтр говорит "ВОЗМОЖНО ЕСТЬ" — идем на диск проверять.
- Возможны ложноположительные срабатывания (False Positive), но ложноотрицательные (False Negative) невозможны.

Для разработчика важно уметь выбрать размер фильтра (m битов) под допустимый % ошибок (например, 1%).

## Часть 2: Streaming Analytics
Задача: найти топ-10 абонентов, качающих торренты (Top Talkers), имея поток 10 Гбит/с и всего 1 МБ памяти для аналитики.
Хранить `map[IMSI]int` нельзя — уникальных IMSI миллионы, память кончится.

**Count-Min Sketch** — это вероятностная структура данных для оценки частоты событий.
- Похожа на Bloom Filter, но хранит не биты, а счетчики.
- Гарантирует, что мы можем переоценить частоту (Overestimate) из-за коллизий, но никогда не недооценим (Underestimate).
- Позволяет строить "Top-K" отчетов в реальном времени с минимальной памятью.

## Часть 3: Распределенные системы
Когда данных становится больше, чем влезает на один диск, мы строим кластер.

**Consistent Hashing (Шардирование)**
Как размазать 1 ПБ данных по 100 серверам так, чтобы при падении одного сервера переезжала только 1/100 часть данных? Обычный `hash % N` тут не работает (переедет почти всё). Используется хеш-кольцо.

**RAFT (Консенсус)**
Как гарантировать, что все реплики записали данные в одном порядке?
Алгоритм RAFT выбирает лидера, который раздает Log (тот самый WAL!) всем последователям. Если вы поняли WAL в LSM, вы поймете и RAFT Log Replication.

## Где смотреть в коде
- Фильтр Блума: `internal/bloom/bloom.go`
- Потоковые алгоритмы: `internal/stream/cms.go`
- Задание: `assignments/day3.md`
