# День 2: CDR Storage и LSM Tree

## Call Detail Records (CDR)
Каждый звонок, SMS или интернет-сессия генерирует CDR-запись. Эти записи нужны для биллинга (списать деньги) и СОРМ (законные требования).
Поток CDR огромен и непрерывен.

**Проблема B-Tree (классических БД):**
При вставке случайных ключей (UUID сессии) головка жесткого диска (или контроллер SSD) вынуждена постоянно прыгать по разным секторам (Random I/O). Это медленно.

**Решение LSM (Log-Structured Merge Tree):**
Мы всегда пишем только в конец файла (Append Only / Sequential I/O). Это максимально быстро на любом носителе.

## Архитектура LSM

### 1. Memtable (Memory)
Все новые данные сначала попадают в **Memtable** (наш SkipList из Дня 1). В памяти данные сортируются мгновенно.

### 2. WAL (Write Ahead Log)
Память энергозависима. Чтобы не потерять CDR при отключении питания, перед записью в Memtable мы добавляем запись в **WAL** на диске. Это просто append-file, читать его нужно только при аварийном восстановлении.

### 3. SSTable (Sorted String Table)
Когда Memtable переполняется (например, 64MB), мы:
1. Замораживаем её (immutable).
2. Сбрасываем (Flush) на диск в виде **SSTable**.
3. Удаляем старый WAL.

**SSTable** — это файл, где ключи лежат по порядку. Благодаря этому мы можем искать в нем, не загружая целиком в память (используя Sparse Index).

### 4. Compaction (Уборка)
Со временем у нас накопится 1000 мелких файлов SSTable. Искать ключ в 1000 файлах — медленно (**Read Amplification**).
Фоновый процесс Compaction берет несколько SSTable, сливает их (как в Merge Sort) и создает один новый, более крупный файл. При этом удаляются дубликаты и "удаленные" записи (Tombstones).

## Баланс стоимостей
LSM меняет профиль нагрузки:
- **Write**: Очень быстро (Append).
- **Read**: Медленнее (нужно проверить Memtable + несколько SSTable).
- **Space**: Требует запас места для Compaction.

Для CDR, которые пишутся постоянно, а читаются редко — это идеальный баланс.

## Где смотреть в коде
- Заготовка SSTable: `internal/sstable/sstable.go`
- Лог WAL: `internal/wal/wal.go`
- Оркестратор LSM: `internal/lsm/lsm.go`
- Задание: `assignments/day2.md`
